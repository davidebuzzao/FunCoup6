<!-- Interactions table, imported from network.html -->
{% csrf_token %}
{% load dictFilter %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://d3js.org/d3-selection-multi.v1.min.js"></script>

<div class="networkTabContainer">
<div class="accordion interactionsAccordion" id="interactionsAccordion">
  <!-- Iterating over all species (multiple for comparative and host-pathogen interactomics) -->
  {% for sp in parameters.species %}
  <!-- Special treatment for the query proteins for the query species -->
  {% if forloop.counter0 == 0 %}
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button InteractorAccordion" type="button" data-bs-toggle="collapse" data-bs-target="#queryInteractionsAccordion{{sp.short}}" aria-expanded="true" aria-controls="queryInteractionsAccordion">
        {% if parameters.numSpecies > 1 %}
          Query Interactions {{sp.speciesName}}
        {% else %}
          Query Interactions
        {% endif %}
      </button>
    </h2>
    <div id="queryInteractionsAccordion{{sp.short}}" class="accordion-collapse collapse show">
      <div class="accordion-body">
        <div class="row rotatedRow">
          <div class="col width12">Interaction partners</div>
          <div class="col width6">Confidence</div>
          <!-- <div class="col width4">FBS</div> -->
          <div class="col width8">Network</div>
          <div class="col width25">
            <div class="row mb-2">Evidence type</div>
            <div class="row mb-2 rotatedRow flex">
              {% for evidence in parameters.evidenceTypes %}
                <div class="col pointer p-0 verticaltext" title='{{evidence}}'>{{evidence}}</div>
              {% endfor %}
            </div>
          </div>
          <div class="col width40">
            <div class="row mb-2">Species</div>
            <div class="row mb-2 rotatedRow flex">
              {% for species in parameters.instanceSpecies %}
              <div class="col pointer p-0 verticaltext" title='{{species.full}}'>{{species.short}}</div>
              {% endfor %}
            </div>
          </div>
          <div class="col width10_label">
            GS
            <!-- Tooltip for the color schema, unfortunatley all colors in here must be handeled from funcoup.css, update there if changes -->
            <i class="bi-question-circle" data-bs-custom-class="whiteTooltip" data-bs-html="true" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="
            Log-likelihood ratio (LLR):<br>
            <div class='colorBox_highlyPos'></div>Highly positive
            <div class='colorBox_pos'></div>Positive
            <div class='colorBox_zero'></div>Zero
            <div class='colorBox_neg'></div>Negative
            <div class='colorBox_highlyNeg'></div>Highly negative
            <br><br>Known coupling<br>
            <div class='colorBox_knownThis'></div>This network
            <div class='colorBox_knownOther'></div>Other network
            <div class='colorBox_zero'></div>Unknown
            <br><br>Confidence based on<br>
            <div class='colorBox_inferredPPV'></div>GoldStnd.
            <div class='colorBox_computedPPV'></div>Evidence
            <br>
            "></i>
          </div>
        </div>
        <div class="row rotatedRow">
        <div class="accordion accordion-flush p-0" id="QueryinteractionsAccordion">     
        {% for id,node in data.nodes.items %}
          {% if node.queryNode == "True" %}
          <div class="accordion-item" >
            <h2 class="accordion-header">
              <button  class="accordion-button p-1" type="button" data-bs-toggle="collapse" data-bs-target="#{{node.uniprotID}}InteractionsAccordion" aria-expanded="true" aria-controls="{{node.uniprotID}}InteractionsAccordion">
                {{node.uniprotID}}
              </button>
            </h2>
            <div id="{{node.uniprotID}}InteractionsAccordion" class="accordion-collapse collapse show">
              <div class="accordion-body p-0">
                <div class="accordion accordion-flush p-0" id="{{node.uniprotID}}interactions">
                  {% for partner in node.linkedNodes %}
                    {% get_link data.links id partner as link%}
                    {% if link.scoresPerGoldStandard != "" %}
                    {% get_value data.nodes partner as partnerNode%} 
                    <div id='interactions_row_{{link.source}}_{{partnerNode.id}}' class="accordion-item">
                      <h2 class="accordion-header">
                        <div class="accordion-button pl-2 pb-0 pt-0 pr-0 couplingLine collapsed" type="button " data-bs-toggle="collapse" data-bs-target="#{{node.uniprotID}}-{{partnerNode.uniprotID}}InteractionsAccordion" aria-expanded="false" aria-controls="{{node.uniprotID}}-{{partnerNode.uniprotID}}InteractionsAccordion">
                          <div class="row rotatedRow " onmouseover='mouseOverLink(0,{{link}})' onmouseout='mouseOutLink(0,{{link}})'>
                          <div class="col width12 small mb-1 ">
                            {% if partnerNode.id == link.source  %}
                              {% if link.direction == 2 %}
                                <i class="bi-arrow-right "></i>
                              {% elif link.direction == 3 %}
                                <i class="bi-arrow-left "></i>
                              {% elif link.direction == 5 %}
                                <i class="bi-arrow-left-right "></i>
                              {% else %}
                                <i class="bi-arrow-left-right white"></i> <!-- making a white symbol in order to just take up the same space -->
                              {% endif %}
                            {% elif partnerNode.id == link.target  %}
                              {% if link.direction == 2 %}
                                <i class="bi-arrow-left "></i>
                              {% elif link.direction == 3 %}
                                <i class="bi-arrow-right "></i>
                              {% elif link.direction == 5 %}
                                <i class="bi-arrow-left-right "></i>
                              {% else %}
                                <i class="bi-arrow-left-right white"></i> <!-- making a white symbol in order to just take up the same space -->
                              {% endif %}
                            {% endif %}
                
                            {{partnerNode.uniprotID}}
                          </div>
                          <div class="col width6 small mb-1 "> {{link.scoresPerGoldStandard.0.ppv}}</div>
                          <!-- <div class="col width4 small mb-1 "> {{link.scoresPerGoldStandard.0.fbs}}</div> -->
                          <div class="col width8 small mb-1 "> {{link.scoresPerGoldStandard.0.type}}
                            {% if partnerNode.id == link.source  %}
                              {% if link.scoresPerGoldStandard.0.direction == 2 %}
                                <i class="bi-arrow-right pl10"></i>
                              {% elif link.scoresPerGoldStandard.0.direction == 3 %}
                                <i class="bi-arrow-left pl10"></i>
                              {% elif link.scoresPerGoldStandard.0.direction == 5 %}
                                <i class="bi-arrow-left-right pl10"></i>
                              {% endif %}
                            {% elif partnerNode.id == link.target  %}
                              {% if link.scoresPerGoldStandard.0.direction == 2 %}
                                <i class="bi-arrow-left pl10"></i>
                              {% elif link.scoresPerGoldStandard.0.direction == 3 %}
                                <i class="bi-arrow-right pl10"></i>
                              {% elif link.scoresPerGoldStandard.0.direction == 5 %}
                                <i class="bi-arrow-left-right pl10"></i>
                              {% endif %}
                            {% endif %}
                            </div>
                          <div class="col width25 flex"> 
                          {% for llrEvidence in link.scoresPerGoldStandard.0.evidenceLlrs %}
                            <div class="colorBox " title='{{llrEvidence.type}}&nbsp;LLR:&nbsp;{{llrEvidence.llr}}' style='background-color:{{llrEvidence.color}}'></div>
                          {% endfor %}
                        </div>
                        <div class="col width40 flex "> 
                          {% for llrSpecies in link.scoresPerGoldStandard.0.evidenceSpecies %}
                            <div class="colorBox " title='{{llrSpecies.type}}&nbsp;LLR:&nbsp;{{llrSpecies.llr}}' style='background-color:{{llrSpecies.color}}'></div>
                          {% endfor %}
                        </div>
                        <div class="col width10 flex_center "> 
                          {% if link.scoresPerGoldStandard.0.known == "None" %}
                            <div class="colorBox " style='background-color:white'></div>
                          {% elif link.scoresPerGoldStandard.0.known == "This" and link.scoresPerGoldStandard.0.isPPVgoldstandard == 0 %}
                            <div class="colorBox " style='background-color:#f4d35e'></div>
                          {% elif link.scoresPerGoldStandard.0.known == "This" and link.scoresPerGoldStandard.0.isPPVgoldstandard == 1 %}
                            <div class="colorBoxChunky " style='background-color:#f4d35e'></div>
                          {% elif link.scoresPerGoldStandard.0.known == "Other" and link.scoresPerGoldStandard.0.isPPVgoldstandard == 0 %}
                            <div class="colorBox " style='background-color:#faf0ca'></div>  
                          {% elif link.scoresPerGoldStandard.0.known == "Other" and link.scoresPerGoldStandard.0.isPPVgoldstandard == 1 %}
                            <div class="colorBoxChunky " style='background-color:#faf0ca'></div>  
                          {% endif %}
<!-- 
                          {% if link.scoresPerGoldStandard.0.isPPVgoldstandard == 0 %}
                            <div class="colorBox " style='background-color:white'></div>
                          {% elif link.scoresPerGoldStandard.0.isPPVgoldstandard == 1 %}
                            <div class="colorBox " style='background-color:#6a4c93'></div>
                          {% endif %} -->
                            <!-- <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">Details</button> -->
                            <a class="btn btn-outline-secondary btn-sm accordionButton"  onclick="getEvidenceDetails({{link}},0,'{{link.scoresPerGoldStandard.0.type}}', '{{csrf_token}}', '{{link.scoresPerGoldStandard.0.known}}')" href="#detailsPanel" role="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight">
                            <!-- <a class="btn btn-outline-secondary btn-sm accordionButton"  onclick="getEvidenceDetails({{link}},0,'{{link.scoresPerGoldStandard.0.type}}', '{{csrf_token}}', '{{link.scoresPerGoldStandard.0.known}}')" data-bs-toggle="collapse" href="#detailsCollapse" role="button" aria-expanded="false" aria-controls="detailsCollapse"> -->
                              Details
                            </a>
                          </div>  
                        </div>
                      </div>
                      </h2>
                      <div id="{{node.uniprotID}}-{{partnerNode.uniprotID}}InteractionsAccordion" class="accordion-collapse collapse">
                        <div class="accordion-body pt-0 pb-1 mt-1">
                          {% for gsScore in link.scoresPerGoldStandard %}
                            {% if forloop.counter0 != 0 %}
                              <div class="row rotatedRow ">
                                <div class="col width12  mb-1 "></div>
                                <div class="col width6 mb-1 "> {{gsScore.ppv}}</div>
                                <!-- <div class="col width4  mb-1 "> {{gsScore.fbs}}</div> -->
                                <div class="col width8  mb-1 "> {{gsScore.type}}
                                {% if partnerNode.id == link.source  %}
                                  {% if gsScore.direction == 2 %}
                                    <i class="bi-arrow-right pl10"></i>
                                  {% elif gsScore.direction == 3 %}
                                    <i class="bi-arrow-left pl10"></i>
                                  {% elif gsScore.direction == 5 %}
                                    <i class="bi-arrow-left-right pl10"></i>
                                  {% endif %}
                                {% elif partnerNode.id == link.target  %}
                                  {% if gsScore.direction == 2 %}
                                    <i class="bi-arrow-left pl10"></i>
                                  {% elif gsScore.direction == 3 %}
                                    <i class="bi-arrow-right pl10"></i>
                                  {% elif gsScore.direction == 5 %}
                                    <i class="bi-arrow-left-right pl10"></i>
                                  {% endif %}
                                {% endif %}
                                </div>
                                <div class="col width25 flex  mb-1"> 
                                  {% for llrEvidence in gsScore.evidenceLlrs %}
                                    <div class="colorBox " title='{{llrEvidence.type}}&nbsp;LLR:&nbsp;{{llrEvidence.llr}}' style='background-color:{{llrEvidence.color}}'></div>
                                  {% endfor %}
                                </div>
                                <div class="col width40 flex  mb-1"> 
                                  {% for llrSpecies in gsScore.evidenceSpecies %}
                                    <div class="colorBox " title='{{llrSpecies.type}}&nbsp;LLR:&nbsp;{{llrSpecies.llr}}' style='background-color:{{llrSpecies.color}}'></div>
                                  {% endfor %}
                                </div>
                                <div class="col width10 flex_center  mb-1"> 
                                  {% if gsScore.known == "None"%}
                                  <div class="colorBox " style='background-color:white'></div>
                                  {% elif gsScore.known == "This" and gsScore.isPPVgoldstandard == 0 %}
                                    <div class="colorBox " style='background-color:#f4d35e'></div>
                                  {% elif gsScore.known == "This" and gsScore.isPPVgoldstandard == 1 %}
                                    <div class="colorBoxChunky " style='background-color:#f4d35e'></div>
                                  {% elif gsScore.known == "Other" and gsScore.isPPVgoldstandard == 0%}
                                    <div class="colorBox " style='background-color:#faf0ca'></div>  
                                  {% elif gsScore.known == "Other" and gsScore.isPPVgoldstandard == 1 %}
                                    <div class="colorBoxChunky " style='background-color:#faf0ca'></div>  
                                  {% endif %}

                                  <a class="btn btn-outline-secondary btn-sm accordionButton"  onclick="getEvidenceDetails({{link}},{{forloop.counter0}},'{{gsScore.type}}','{{csrf_token}}', '{{gsScore.known}}')" href="#detailsPanel" role="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight">
                                  <!-- <a class="btn btn-outline-secondary btn-sm accordionButton" onclick="getEvidenceDetails({{link}},{{forloop.counter0}},'{{gsScore.type}}','{{csrf_token}}', '{{gsScore.known}}')"  data-bs-toggle="collapse" href="#detailsCollapse" role="button" aria-expanded="false" aria-controls="detailsCollapse"> -->
                                    Details
                                  </a>
                                </div>  
                              </div>
                            {% endif %}
                          {% endfor %}
                        </div>
                      </div>
                    </div>
                    {% endif %}
                  {% endfor %}
                </div>

              </div>
            </div>
          </div>
              
        {% endif %}
      {% endfor %}
        </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  <!-- One more round of tables here for the non-query interactions or interactinos for other species -->
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button InteractorAccordion collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#subnetworknteractionsAccordion{{sp.short}}" aria-expanded="false" aria-controls="subnetworknteractionsAccordion">
        {% if parameters.numSpecies > 1 %}
          Subnetwork gene interactions {{sp.speciesName}}
        {% else %}
          Subnetwork gene interactions
        {% endif %}

      </button>
    </h2>
    <div id="subnetworknteractionsAccordion{{sp.short}}" class="accordion-collapse collapse">
      <div class="accordion-body">
        <div class="row rotatedRow">
          <div class="col width12">Interaction partners</div>
          <div class="col width6">Confidence</div>
          <!-- <div class="col width4">FBS</div> -->
          <div class="col width8">Network</div>
          <div class="col width25">
            <div class="row mb-2">Evidence type</div>
            <div class="row mb-2 rotatedRow flex">
              {% for evidence in parameters.evidenceTypes %}
                <div class="col pointer p-0 verticaltext" title='{{evidence}}'>{{evidence}}</div>
              {% endfor %}
            </div>
          </div>
          <div class="col width40">
            <div class="row mb-2">Species</div>
            <div class="row mb-2 rotatedRow flex">
              {% for species in parameters.instanceSpecies %}
              <div class="col pointer p-0 verticaltext" title='{{species.full}}'>{{species.short}}</div>
              {% endfor %}
            </div>
          </div>
          <div class="col width10_label">
            <!-- In Gold st.  -->
            GS
            <!-- Tooltip for the color schema, unfortunatley all colors in here must be handeled from funcoup.css, update there if changes -->
            <i class="bi-question-circle" data-bs-custom-class="whiteTooltip" data-bs-html="true" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="
            Log-likelihood ratio (LLR):<br>
            <div class='colorBox_highlyPos'></div>Highly positive
            <div class='colorBox_pos'></div>Positive
            <div class='colorBox_zero'></div>Zero
            <div class='colorBox_neg'></div>Negative
            <div class='colorBox_highlyNeg'></div>Highly negative
            <br><br>Known coupling<br>
            <div class='colorBox_knownThis'></div>This network
            <div class='colorBox_knownOther'></div>Other network
            <div class='colorBox_zero'></div>Unknown
            <br><br>Confidence based on<br>
            <div class='colorBox_inferredPPV'></div>GoldStnd.
            <div class='colorBox_computedPPV'></div>Evidence
            <br>
            "></i>
          </div>
        </div>
        <div class="row rotatedRow">
        <div class="accordion accordion-flush p-0" id="QueryinteractionsAccordion">     
          {% for id,node in data.nodes.items %}
          {% if node.species.speciesName == sp.speciesName %}
          {% if node.queryNode == "False" %}
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button p-1" type="button" data-bs-toggle="collapse" data-bs-target="#{{node.uniprotID}}InteractionsAccordion" aria-expanded="true" aria-controls="{{node.uniprotID}}InteractionsAccordion">
                {{node.uniprotID}}
              </button>
            </h2>
            <div id="{{node.uniprotID}}InteractionsAccordion" class="accordion-collapse collapse">
              <div class="accordion-body p-0">
                <div class="accordion accordion-flush p-0" id="{{node.uniprotID}}interactions">
                  {% for partner in node.linkedNodes %}
                    {% get_link data.links id partner as link%}
                    {% if link.scoresPerGoldStandard != "" %}
                    {% get_value data.nodes partner as partnerNode%} 
                    <div id='interactions_row_{{link.source}}_{{partnerNode.id}}' class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button pl-2 pb-0 pt-0 pr-0 " type="button" data-bs-toggle="collapse" data-bs-target="#{{node.uniprotID}}-{{partnerNode.uniprotID}}InteractionsAccordion" aria-expanded="true" aria-controls="{{node.uniprotID}}-{{partnerNode.uniprotID}}InteractionsAccordion">
                          <div class="row rotatedRow " onmouseover='mouseOverLink(0,{{link}})' onmouseout='mouseOutLink(0,{{link}})'>
                          <div class="col width12 small mb-1 ">
                            {% if partnerNode.id == link.source  %}
                              {% if link.direction == 2 %}
                                <i class="bi-arrow-right"></i>
                              {% elif link.direction == 3 %}
                                <i class="bi-arrow-left"></i>
                              {% elif link.direction == 5 %}
                                <i class="bi-arrow-left-right"></i>
                              {% else %}
                                <i class="bi-arrow-left-right white"></i> <!-- making a white symbol in order to just take up the same space -->
                              {% endif %}
                            {% elif partnerNode.id == link.target  %}
                              {% if link.direction == 2 %}
                                <i class="bi-arrow-left"></i>
                              {% elif link.direction == 3 %}
                                <i class="bi-arrow-right"></i>
                              {% elif link.direction == 5 %}
                                <i class="bi-arrow-left-right"></i>
                              {% else %}
                                <i class="bi-arrow-left-right white"></i> <!-- making a white symbol in order to just take up the same space -->
                              {% endif %}
                            {% endif %}
                            {{partnerNode.uniprotID}}
                          </div>
                          <div class="col width6 small mb-1 "> {{link.scoresPerGoldStandard.0.ppv}}</div>
                          <!-- <div class="col width4 small mb-1 "> {{link.scoresPerGoldStandard.0.fbs}}</div> -->
                          <div class="col width8 small mb-1 "> {{link.scoresPerGoldStandard.0.type}}
                            {% if partnerNode.id == link.source  %}
                              {% if link.scoresPerGoldStandard.0.direction == 2 %}
                                <i class="bi-arrow-right pl10"></i>
                              {% elif link.scoresPerGoldStandard.0.direction == 3 %}
                                <i class="bi-arrow-left pl10"></i>
                              {% elif link.scoresPerGoldStandard.0.direction == 5 %}
                                <i class="bi-arrow-left-right pl10"></i>
                              {% endif %}
                            {% elif partnerNode.id == link.target  %}
                              {% if link.scoresPerGoldStandard.0.direction == 2 %}
                                <i class="bi-arrow-left pl10"></i>
                              {% elif link.scoresPerGoldStandard.0.direction == 3 %}
                                <i class="bi-arrow-right pl10"></i>
                              {% elif link.scoresPerGoldStandard.0.direction == 5 %}
                                <i class="bi-arrow-left-right pl10"></i>
                              {% endif %}
                            {% endif %}
                          </div>
                          <div class="col width25 flex"> 
                          {% for llrEvidence in link.scoresPerGoldStandard.0.evidenceLlrs %}
                            <div class="colorBox " title='{{llrEvidence.type}}&nbsp;LLR:&nbsp;{{llrEvidence.llr}}' style='background-color:{{llrEvidence.color}}'></div>
                          {% endfor %}
                        </div>
                        <div class="col width40 flex "> 
                          {% for llrSpecies in link.scoresPerGoldStandard.0.evidenceSpecies %}
                            <div class="colorBox " title='{{llrSpecies.type}}&nbsp;LLR:&nbsp;{{llrSpecies.llr}}' style='background-color:{{llrSpecies.color}}'></div>
                          {% endfor %}
                        </div>
                        <div class="col width10 flex_center "> 
                          {% if link.scoresPerGoldStandard.0.known == "None" %}
                            <div class="colorBox " style='background-color:white'></div>
                          {% elif link.scoresPerGoldStandard.0.known == "This" and link.scoresPerGoldStandard.0.isPPVgoldstandard == 0 %}
                            <div class="colorBox " style='background-color:#f4d35e'></div>
                          {% elif link.scoresPerGoldStandard.0.known == "This" and link.scoresPerGoldStandard.0.isPPVgoldstandard == 1 %}
                            <div class="colorBoxChunky " style='background-color:#f4d35e'></div>
                          {% elif link.scoresPerGoldStandard.0.known == "Other" and link.scoresPerGoldStandard.0.isPPVgoldstandard == 0 %}
                            <div class="colorBox " style='background-color:#faf0ca'></div>  
                          {% elif link.scoresPerGoldStandard.0.known == "Other" and link.scoresPerGoldStandard.0.isPPVgoldstandard == 1 %}
                            <div class="colorBoxChunky " style='background-color:#faf0ca'></div>  
                          {% endif %}
                          <a class="btn btn-outline-secondary btn-sm accordionButton"  onclick="getEvidenceDetails({{link}},0,'{{link.scoresPerGoldStandard.0.type}}', '{{csrf_token}}', '{{link.scoresPerGoldStandard.0.known}}')" href="#detailsPanel" role="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight">
                          <!-- <a class="btn btn-outline-secondary btn-sm accordionButton"  onclick="getEvidenceDetails({{link}},0,'{{link.scoresPerGoldStandard.0.type}}', '{{csrf_token}}', '{{link.scoresPerGoldStandard.0.known}}')" data-bs-toggle="collapse" href="#detailsCollapse" role="button" aria-expanded="false" aria-controls="detailsCollapse"> -->
                            Details
                          </a>
                          </div>  
                        </div>
                        </button>
                      </h2>
                      <div id="{{node.uniprotID}}-{{partnerNode.uniprotID}}InteractionsAccordion" class="accordion-collapse collapse">
                        <div class="accordion-body pt-0 pb-1 mt-1">
                          {% for gsScore in link.scoresPerGoldStandard %}
                            {% if forloop.counter0 != 0 %}
                              <div class="row rotatedRow ">
                                <div class="col width12  mb-1 "></div>
                                <div class="col width6  mb-1 "> {{gsScore.ppv}}</div>
                                <!-- <div class="col width4  mb-1 "> {{gsScore.fbs}}</div> -->
                                <div class="col width8  mb-1 "> {{gsScore.type}}
                                  {% if partnerNode.id == link.source  %}
                                    {% if gsScore.direction == 2 %}
                                      <i class="bi-arrow-right pl10"></i>
                                    {% elif gsScore.direction == 3 %}
                                      <i class="bi-arrow-left pl10"></i>
                                    {% elif gsScore.direction == 5 %}
                                      <i class="bi-arrow-left-right pl10"></i>
                                    {% endif %}
                                  {% elif partnerNode.id == link.target  %}
                                    {% if gsScore.direction == 2 %}
                                      <i class="bi-arrow-left pl10"></i>
                                    {% elif gsScore.direction == 3 %}
                                      <i class="bi-arrow-right pl10"></i>
                                    {% elif gsScore.direction == 5 %}
                                      <i class="bi-arrow-left-right pl10"></i>
                                    {% endif %}
                                  {% endif %}
                                </div>
                                <div class="col width25 flex  mb-1"> 
                                  {% for llrEvidence in gsScore.evidenceLlrs %}
                                    <div class="colorBox " title='{{llrEvidence.type}}&nbsp;LLR:&nbsp;{{llrEvidence.llr}}' style='background-color:{{llrEvidence.color}}'></div>
                                  {% endfor %}
                                </div>
                                <div class="col width40 flex  mb-1"> 
                                  {% for llrSpecies in gsScore.evidenceSpecies %}
                                    <div class="colorBox " title='{{llrSpecies.type}}&nbsp;LLR:&nbsp;{{llrSpecies.llr}}' style='background-color:{{llrSpecies.color}}'></div>
                                  {% endfor %}
                                </div>
                                <div class="col width10 flex_center  mb-1"> 
                                  {% if gsScore.known == "None"%}
                                  <div class="colorBox " style='background-color:white'></div>
                                  {% elif gsScore.known == "This" and gsScore.isPPVgoldstandard == 0 %}
                                    <div class="colorBox " style='background-color:#f4d35e'></div>
                                  {% elif gsScore.known == "This" and gsScore.isPPVgoldstandard == 1 %}
                                    <div class="colorBoxChunky " style='background-color:#f4d35e'></div>
                                  {% elif gsScore.known == "Other" and gsScore.isPPVgoldstandard == 0%}
                                    <div class="colorBox " style='background-color:#faf0ca'></div>  
                                  {% elif gsScore.known == "Other" and gsScore.isPPVgoldstandard == 1 %}
                                    <div class="colorBoxChunky " style='background-color:#faf0ca'></div>  
                                  {% endif %}
                                  <a class="btn btn-outline-secondary btn-sm accordionButton" onclick="getEvidenceDetails({{link}},{{forloop.counter0}},'{{gsScore.type}}','{{csrf_token}}', '{{gsScore.known}}')" href="#detailsPanel" role="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight">
                                  <!-- <a class="btn btn-outline-secondary btn-sm accordionButton" onclick="getEvidenceDetails({{link}},{{forloop.counter0}},'{{gsScore.type}}','{{csrf_token}}', '{{gsScore.known}}')"  data-bs-toggle="collapse" href="#detailsCollapse" role="button" aria-expanded="false" aria-controls="detailsCollapse"> -->
                                    Details
                                  </a>
                                </div>  
                              </div>
                            {% endif %}
                          {% endfor %}
                        </div>
                      </div>
                    </div>
                    {% endif %}
                  {% endfor %}
                </div>

              </div>
            </div>
          </div>  
          {% endif %}    
        {% endif %}
      {% endfor %}
      </div>
      </div>
    </div>
  </div>
</div>
{% endfor %}
</div>
</div>

<script type="text/javascript">

  // Need this to be able to capture if the collapse is open or closed. only want to do ajax request when open
  // var detailsClosed="open";
  // if (document.getElementById('detailsCollapse')){
  //   var myCollapsible = document.getElementById('detailsCollapse')
  //   myCollapsible.addEventListener('show.bs.collapse', function () {
  //     $('#detailsPanel').show();
  //     detailsClosed="open"
  //   })
  //   var myCollapsible = document.getElementById('detailsCollapse')
  //   myCollapsible.addEventListener('hide.bs.collapse', function () {
  //     detailsClosed="close"
  //   })
  // }

  // // Function to close the details panel
  // function closeDetailsPanel(){
  //   $('#detailsPanel').hide();
  //     detailsClosed="close"
  // }
  
  // Function to trigger ajax call to get link details to put in the details panel
  function getEvidenceDetails(link, index,goldstandard,token,knownCouplingIDs){
    var detailsPanel = document.getElementById('detailsPanel');
    var detailsPanelHeader = document.getElementById('detailsPanelHeader');
    while (child) { 
      detailsPanelHeader.removeChild(child); 
      child = detailsPanelHeader.lastElementChild; 
    } 

    var child = detailsPanel.lastElementChild;  
    while (child) { 
      detailsPanel.removeChild(child); 
      child = detailsPanel.lastElementChild; 
    } 
    detailsPanel.insertAdjacentHTML('beforeend',"<div class='spinner-border' role='status'><span class='sr-only'></span></div>");
    // if (detailsClosed=="open"){
    $.ajax({
      type: "post",
      url: '/linkdetails/'+link.source+'&'+link.target+'&'+goldstandard,
      data: {"csrfmiddlewaretoken" : token },
      success: function(response) {
        newHeaderContent="<button type='button' class='btn-close text-reset' data-bs-dismiss='offcanvas' aria-label='Close'></button>"
        newContent="";
        var typeName=response.goldstandard;
        var hostSpecies=response.species;
        
        newHeaderContent+="<p class='fw-bold text-right'>"+response.uniprotIdA+" - "+response.uniprotIdB+" in "+response.goldstandard +"</p>"

        // newContent+="<button type='button' class='btn-close detailsClose' aria-label='Close' onClick='closeDetailsPanel()'></button>"+"</p>"
        if(response.evidenceDetails.length>0){
          newContent+="<div id='my_dataviz'></div>"
          newContent+="<div class='row small'><div class='col-sm small mw20 fw-bold'>LLR</div> <div class='col-sm small mw40 fw-bold'>Support from</div><div class='col-sm small mw20 fw-bold'>Ev. Type</div><div class='col-sm small mw20 fw-bold'>Species</div></div>"
        }
        for(var index in response.evidenceDetails)
        {
          var details =response.evidenceDetails[index]
          newContent+="<div class='row small'><div class='col-sm small mw20'>"+details.llr.toFixed(3)+"</div>"+"<div class='col-sm small mw40'>"+details.info+"</div>"+"<div class='col-sm small mw20'>"+details.type+"</div>"+"<div class='col-sm small mw20'>"+details.species+"</div>"+"</div>"
        }
        if (knownCouplingIDs=="This"){
          if(typeName=="PPI"){
            newContent+="<p class='small'>Known coupling from the <a href='/help/#PPI'>PPI</a> gold standard</p>"
          }else if (typeName=="Metabolic"){
            newContent+="<p class='small'>Known coupling from the <a href='/help/#Metabolic'>Metabolic</a> gold standard</p>"
          }else if (typeName=="Signaling"){
            newContent+="<p class='small'>Known coupling from the <a href='/help/#Signaling'>Signaling</a> gold standard</p>"
          }else if (typeName=="Complex"){
            newContent+="<p class='small'>Known coupling from the <a href='/help/#Complex'>Complex</a> gold standard</p>"
          }else if (typeName=="Operon"){
            newContent+="<p class='small'>Known coupling from the <a href='/help/#Operon'>Operon</a> gold standard</p>"
          }else if (typeName=="Regulatory"){
            newContent+="<p class='small'>Known coupling from the <a href='/help/#Regulatory'>Regulatory</a> gold standard</p>"
          }
        }
        if (newContent==""){
          newContent="Could not find details for this link"
        }

        var detailsPanelHeader = document.getElementById('detailsPanelHeader');
        var child = detailsPanelHeader.lastElementChild;  
        while (child) { 
          detailsPanelHeader.removeChild(child); 
          child = detailsPanelHeader.lastElementChild; 
        } 
        detailsPanelHeader.insertAdjacentHTML('beforeend',newHeaderContent);

        var detailsPanel = document.getElementById('detailsPanel');
        var child = detailsPanel.lastElementChild;  
        while (child) { 
          detailsPanel.removeChild(child); 
            child = detailsPanel.lastElementChild; 
        } 
        detailsPanel.insertAdjacentHTML('beforeend',newContent);

        // // set the dimensions and margins of the graph
        // const width = 200,
        //     height = 200,
        //     margin = 10;

        // // The radius of the pieplot is half the width or half the height (smallest one). I subtract a bit of margin.
        // const radius = Math.min(width, height) / 2 - margin;

        // // append the svg object to the div called 'my_dataviz'
        // const svg = d3.select("#my_dataviz")
        //   .append("svg")
        //     .attr("width", width)
        //     .attr("height", height)
        //     .attr("class","pieChart")
        //   .append("g")
        //     .attr("transform", `translate(${width/2}, ${height/2})`);

        // const data = response.dataForChart;
        // // set the color scale
        // const color={'DOM':'#6CB4EE', 'GIN':'#007FFF', 'MEX':'#0066b2', 'MIR':'#002D62', 'PEX':'#0000FF', 
        // 'PHP':'#5072A7', 'PIN':'#89CFF0', 'QMS':'#002244', 'SCL':'#6699CC', 'TFB':'#B9D9EB'}
        // // Compute the position of each group on the pie:
        // const pie = d3.pie()
        //   .value(function(d) {return d[1]})
        // const data_ready = pie(Object.entries(data))
        // // shape helper to build arcs:
        // var arcGenerator = d3.arc()
        //   .innerRadius(0)
        //   .outerRadius(radius)
        // // Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
        // svg.selectAll('mySlices')
        //   .data(data_ready)
        //   .enter()
        //   .append('path')
        //     .attr('d', arcGenerator)
        //     .attr('fill', function(d){ return(color[d.data[0]]) })
        //     .attr("stroke", "black")
        //     .style("stroke-width", "0px")
        //     .style("opacity", 0.7)
        // // Now add the annotation. Use the centroid method to get the best coordinates
        // svg.selectAll('mySlices')
        //   .data(data_ready)
        //   .enter()
        //   .append('text')
        //   .text(function(d){ return  d.data[0]})
        //   .attr("transform", function(d) { 
        //     const centroid = arcGenerator.centroid(d);
        //     const offsetX = centroid[0] * 1; // Adjust this value to increase or decrease the horizontal offset
        //     const offsetY = centroid[1] * 1; // Adjust this value to increase or decrease the vertical offset
        //     return "translate(" + offsetX + "," + offsetY + ")";  
        //   })
        //   .style("text-anchor", "middle")
        //   .style("font-size", 12);


      // Set the dimensions and margins of the graph
      const margin = { top: 10, right: 20, bottom: 50, left: 40},
          width = 250 - margin.left - margin.right,
          height = 200 - margin.top - margin.bottom;

      // Append the SVG object to the div called 'my_dataviz'
      const svg = d3.select("#my_dataviz")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .attr("class", "barChart")
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

      const data = response.dataForChart;

      // Sort data by value in descending order
      const sortedData = Object.entries(data).sort((a, b) => b[1] - a[1]);

      // Filter out entries with value 0
      const filteredData = sortedData.filter(([key, value]) => value > 0);

      // X axis
      const x = d3.scaleBand()
          .range([0, width])
          .domain(filteredData.map(([key, value]) => key))
          .padding(0.2);

      svg.append("g")
          .attr("transform", `translate(0,${height})`)
          .call(d3.axisBottom(x))
          .selectAll("text")
          .attr("transform", "translate(-10,0)rotate(-45)")
          .style("text-anchor", "end");

      // Add Y axis
      const y = d3.scaleLinear()
          .domain([0, d3.max(filteredData.map(([key, value]) => value))])
          .range([height, 0]);

      // Adjusting Y axis tick values
      svg.append("g")
          .call(d3.axisLeft(y).ticks(5));

      // Add Y axis title
      svg.append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 0 - margin.left)
          .attr("x", 0 - (height / 2))
          .attr("dy", "1em")
          .style("text-anchor", "middle")
          .text("LLR")
          .attr("font-family", "sans-serif")
          .attr("font-size", 10);
      
      // Bars
      svg.selectAll("mybar")
          .data(filteredData)
          .enter()
          .append("rect")
          .attr("x", d => x(d[0]))
          .attr("y", d => y(d[1]))
          .attr("width", x.bandwidth() * 0.8) // Make bars narrower
          .attr("height", d => height - y(d[1]))
          .attr("fill", "#e8555f")
          .style("stroke", "black") // Black border
          .style("stroke-width", 2); // Thick border 
        
      }
    });
    // }   
  }

</script>
